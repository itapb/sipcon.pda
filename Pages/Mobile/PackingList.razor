@page "/mobile-packinglist"
@using Sipcon.Mobile.WebApp.Layout
@using Sipcon.Mobile.WebApp.Pages.Mobile.Models
@layout MobileLayout

<div style="flex-shrink: 0;" class="pa-3 jpv1-dialog-body-background" @onclick:stopPropagation="true">
    <MudPaper Elevation="2" Class="pa-3">
        <MudGrid Spacing="2">
            <MudItem xs="12">
                <MudStack Row="false" Class="pa-2 mud-theme-info mud-typography-h6" Spacing="1" style="line-height:1.1;">
                    <div>CLIENTE : @CustomerName</div>
                    <MudStack Row="true" StretchItems="StretchItems.Start" Justify="Justify.FlexEnd">
                        <div>BULTO: @PackingCode</div>
                    </MudStack>
                </MudStack>
            </MudItem>
            <MudItem xs="12">
                <MudTextField T="string"
                              Margin="Margin.Dense"
                              OnAdornmentClick="OnSearchClicK"
                              Clearable="true"
                              TextUpdateSuppression="@IsTextUpdateSuppression"
                              Immediate="true"
                              OnKeyDown="CodeFieldOnKeyDown"
                              @bind-Value="searchString"
                              OnClearButtonClick="OnClearClick"
                              Placeholder="Buscar"
                              @ref="searchStringField"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Class="mt-0"
                              HelperText="@mHelpText"
                              Variant="Variant.Filled"
                              HelperId="custom-helper-text" />
            </MudItem>
            <!-- Vista de Búsqueda SIN Acordeón -->
            <MudItem xs="12">
                @if (isSearching && !string.IsNullOrEmpty(searchString) && searchString.Trim().Length >= 3)
                {
                    <MudPaper Elevation="1" Class="pa-2 mb-3">
                        @if (searchResults.Any())
                        {
                            <MudText Typo="Typo.h6" Class="mb-3">Resultados de búsqueda</MudText>
                            <!-- DataGrid para búsqueda -->
                            <MudDataGrid T="Models.PackageList"
                                         Items="@searchResults"
                                         Striped="true"
                                         Hover="true"
                                         Loading="_loading"
                                         Filterable="false"
                                         FixedHeader="true"
                                         Height="400px"
                                         Class="hide-datagrid-headers">
                                <Columns>
                                    <TemplateColumn>
                                        <CellTemplate>
                                            <MudItem xs="12">
                                                <MudStack Row="true" Justify="Justify.SpaceBetween" Style="width: 100%;" Spacing="2">
                                                    <div style="flex: 3; text-align: left;">
                                                        <span style="font-weight: normal;">@context.Item.PartInnerCode</span>
                                                        <span style="margin-left: 15px;">@context.Item.PartName</span>
                                                    </div>
                                                    <div style="flex: 2; text-align: left;">
                                                        @context.Item.CustomerName
                                                    </div>
                                                    <div style="flex: 1; text-align: right;">
                                                        @context.Item.Quantity
                                                    </div>
                                                </MudStack>
                                            </MudItem>
                                        </CellTemplate>
                                    </TemplateColumn>
                                </Columns>
                            </MudDataGrid>
                        }
                    </MudPaper>
                }
            </MudItem>
            <!-- Vista Inicial con Acordeón -->
            <MudItem xs="12">
                @if (showInitialData)
                {
                    <MudPaper Elevation="1" Class="pa-2 mb-3">
                        @if (groupedInitialData.Any())
                        {
                            <MudExpansionPanels MultiExpansion="false">
                                @foreach (var dealerGroup in groupedInitialData)
                                {
                                    var itemCount = dealerGroup.Count();
                                    var totalQuantity = dealerGroup.Sum(x => x.Quantity ?? 0);

                                    <MudExpansionPanel Text="@($"{dealerGroup.Key} - {itemCount} items")"
                                                       @key="@dealerGroup.Key">
                                        <ChildContent>
                                            <MudTable Items="@dealerGroup" Dense="true" Hover="true" Striped="true">
                                                <HeaderContent>
                                                    <MudTh>Descripción</MudTh>
                                                    <MudTh Style="text-align: right;">Cantidad</MudTh>
                                                </HeaderContent>
                                                <RowTemplate>
                                                    <MudTd DataLabel="Descripción">@context.PartName</MudTd>
                                                    <MudTd DataLabel="Cantidad" Style="text-align: right;">@context.Quantity</MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                }
                            </MudExpansionPanels>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">No hay datos disponibles</MudAlert>
                        }
                    </MudPaper>
                }
            </MudItem>
            <MudItem xs="12">
                <MudStack Row="true" Justify="Justify.Center">
                    <MudStack Row="true" Spacing="5">
                        <MudFab Color="Color.Success"
                                StartIcon="@Icons.Material.Filled.Refresh"
                                Size="Size.Medium"
                                OnClick="ClickRefreshPackingPending" />
                        <MudFab Color="Color.Secondary"
                                StartIcon="@Icons.Material.Filled.Close"
                                Size="Size.Medium"
                                Href="process-list" />
                    </MudStack>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>
</div>
<style>
    #custom-helper-text {
        font-size: 1rem;
        color: @(IsTextUpdateSuppression ? "red" : "blue");
        font-style: italic;
    }

    .scrollable-container {
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
    }
</style>

@code {
    protected override async Task OnInitializedAsync()
    {
        await LoadInitialPackingList();
    }

    [Inject] private UserSession Session { get; set; } = null!;
    [Inject] private Repository.Auth.AuthenticationProviderJWT AuthenticationStateProvider { get; set; } = null!;
    [Inject] private HttpClient Http { get; set; } = default!;

    bool IsTextUpdateSuppression = true;
    bool _loading = false;
    bool _loadingInitial = true;
    bool showInitialData = true;
    bool isSearching = false;
    private bool searchTriggered = false;

    private string searchString { get; set; } = "";
    private MudTextField<string>? searchStringField;
    private string PackingCode = "";
    private string CustomerName = "";
    string mHelpText = "";

    private List<Models.PackageList> initialData = new List<Models.PackageList>();
    private List<Models.PackageList> searchResults = new List<Models.PackageList>();

    // Nuevas propiedades para agrupar datos por concesionario
    private List<IGrouping<string, Models.PackageList>> groupedInitialData = new List<IGrouping<string, Models.PackageList>>();

    private void GroupData(List<Models.PackageList> data)
    {
        if (data == null || !data.Any())
        {
            groupedInitialData = new List<IGrouping<string, Models.PackageList>>();
            return;
        }

        // Agrupar por CustomerName (concesionario)
        var grouped = data
            .Where(x => !string.IsNullOrWhiteSpace(x.CustomerName))
            .GroupBy(x => (x.CustomerName ?? string.Empty).Trim())
            .OrderBy(g => g.Key)
            .ToList();

        groupedInitialData = grouped;
    }

    private async Task ClickRefreshPackingPending(MouseEventArgs ev)
    {
        mHelpText = "";
        CustomerName = "";
        PackingCode = "";
        searchString = "";
        showInitialData = true;
        isSearching = false;
        searchTriggered = false;
        searchResults.Clear();

        await LoadInitialPackingList();
        await searchStringField!.FocusAsync();
    }

    private async Task OnSearchClicK(MouseEventArgs args)
    {
        if (searchTriggered) return;
        searchTriggered = true;
        try
        {
            await ExecuteSearch();
        }
        finally
        {
            await Task.Delay(300);
            searchTriggered = false;
        }
    }

    private async Task ExecuteSearch()
    {
        var searchTerm = searchString?.Trim() ?? "";

        if (searchTerm.Length >= 3)
        {
            IsTextUpdateSuppression = false;
            mHelpText = "Buscando...";
            showInitialData = false;
            isSearching = true;
            StateHasChanged();

            await Task.Delay(1);
            await PerformSearch(searchTerm);

            mHelpText = searchResults.Any() ? "" : "No se encontraron resultados";
            await searchStringField!.FocusAsync();
        }
        else if (string.IsNullOrEmpty(searchTerm))
        {
            mHelpText = "";
            showInitialData = true;
            isSearching = false;
            searchResults.Clear();
            StateHasChanged();
        }
    }

    private async Task PerformSearch(string searchTerm)
    {
        await AuthenticationStateProvider.RefresMobileStaticVariables();
        _loading = true;
        StateHasChanged();

        try
        {
            HttpResponseMessage response = await Http.GetAsync($"api/Packing/GetPackageList?supplierId={Session.SupplierId}&packageCode={searchTerm}");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadFromJsonAsync<WebApiResponse<List<Models.PackageList>>>();
                searchResults = content?.data ?? new List<Models.PackageList>();

                // NO llamamos a GroupData aquí porque el buscador ya no usa acordeón

                if (searchResults.Any())
                {
                    CustomerName = searchResults.FirstOrDefault()?.CustomerName ?? "";
                    PackingCode = searchResults.FirstOrDefault()?.Code ?? "";
                }
                else
                {
                    CustomerName = "";
                    PackingCode = "";
                }
            }
            else
            {
                mHelpText = "Error en la búsqueda";
                searchResults.Clear();
            }
        }
        catch (Exception ex)
        {
            mHelpText = $"Error: {ex.Message}";
            searchResults.Clear();
        }

        _loading = false;
        IsTextUpdateSuppression = true;
        StateHasChanged();
    }

    private async Task OnClearClick(MouseEventArgs args)
    {
        mHelpText = "";
        searchString = string.Empty;
        showInitialData = true;
        isSearching = false;
        searchTriggered = false;
        searchResults.Clear();
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task CodeFieldOnKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            if (searchTriggered) return;
            searchTriggered = true;
            try
            {
                await ExecuteSearch();
            }
            finally
            {
                await Task.Delay(300);
                searchTriggered = false;
            }
        }
        else if (args.Key == "Escape")
        {
            searchString = string.Empty;
            showInitialData = true;
            isSearching = false;
            searchTriggered = false;
            searchResults.Clear();
            StateHasChanged();
        }
    }

    private async Task LoadInitialPackingList()
    {
        await AuthenticationStateProvider.RefresMobileStaticVariables();
        _loadingInitial = true;
        showInitialData = true;
        isSearching = false;
        searchTriggered = false;

        try
        {
            HttpResponseMessage response = await Http.GetAsync($"api/Packing/GetPackingList?supplierId={Session.SupplierId}");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadFromJsonAsync<WebApiResponse<List<Models.PackageList>>>();
                initialData = content?.data ?? new List<Models.PackageList>();

                // Agrupar datos iniciales por concesionario
                GroupData(initialData);
            }
            else
            {
                CustomerName = "Error cargando datos";
                PackingCode = "";
            }
        }
        catch (Exception)
        {
            CustomerName = "Error de conexión";
            PackingCode = "";
        }

        _loadingInitial = false;
        StateHasChanged();
    }
}